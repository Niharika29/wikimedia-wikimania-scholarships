{# Form rendering helpers #}

{# FIXME: document macro args #}

{% macro div( ctx, mesg, name, opts = {} ) %}
{% set opts = { 'class':false }|merge( opts ) %}
<div class="form-group {{ opts['class'] ? opts['class'] ~ ' '}}{{ name in ctx.form.errors ? 'has-error' }}">
{% endmacro %}

{% macro li( ctx, mesg, name, opts = {} ) %}
{% set opts = { 'class':false }|merge( opts ) %}
<li class="{{ opts['class'] ? opts['class'] ~ ' '}}{{ name in ctx.form.errors ? 'fieldWithErrors' }}">
{% endmacro %}

{% macro label( ctx, mesg, name, opts = {} ) %}
{% set opts = { 'required':false, 'escape':true }|merge( opts ) %}
{% set tran = ctx.wgLang.message( mesg ) %}
<label for="{{ name }}" class="{{ opts['required'] ? 'required' }}">{% if
    opts['escape'] == false %}{{ tran|raw }}{% else %}{{ tran }}{% endif %}</label>
{% endmacro %}

{% macro startElement( ctx, mesg, name, opts = {} ) %}
{% import _self as forms %}
{{ forms.div( ctx, mesg, name, opts ) }}
{{ forms.label( ctx, mesg, name, opts ) }}
{% endmacro %}

{% macro endElement() %}
</div>
{% endmacro %}

{% macro text( ctx, mesg, name, opts = {} ) %}
{% import _self as forms %}
{% set opts = { 'required':false }|merge( opts ) %}
{% set value = ctx.form.get( name ) %}
{{ forms.startElement( ctx, mesg, name, opts ) }}
<input type="text" class="form-control" id="{{ name }}" name="{{ name }}" value="{{ value ?: '' }}" {{ opts['required'] ? 'required' }}/>
{{ forms.endElement() }}
{% endmacro %}

{% macro textArea( ctx, mesg, name, opts = {} ) %}
{% import _self as forms %}
{% set opts = { 'required':false }|merge( opts ) %}
{% set value = ctx.form.get( name ) %}
{{ forms.startElement( ctx, mesg, name, opts ) }}
  <textarea class="form-control" id="{{ name }}" name="{{ name }}" cols="80" rows="3" {{ opts['required'] ? 'required' }}>{{ value ?: '' }}</textarea>
{{ forms.endElement() }}
{% endmacro %}

{% macro countrySelect( ctx, mesg, name, opts = {} ) %}
{% import _self as forms %}
{% set opts = { 'required':false }|merge( opts ) %}
{% set value = ctx.form.get( name ) %}
{{ forms.startElement( ctx, mesg, name, opts ) }}
<select class="form-control" id="{{ name }}" name="{{ name }}" {{ opts['required'] ? 'required' }}>
  <option value="">{{ ctx.wgLang.message( 'form-select' ) }}</option>
  {% for code, country in ctx.countries %}
    <option value="{{ code }}" {{ code == value ? 'selected="selected"' }}>{{ country }}</option>
  {% endfor %}
  </select>
{{ forms.endElement() }}
{% endmacro %}

{% macro yesNo( ctx, mesg, name, opts = {} ) %}
{% import _self as forms %}
{% set value = ctx.form.get( name ) %}
{{ forms.startElement( ctx, mesg, '', opts ) }}
  <div class="form-inline">
  <label class="radio-inline">
    <input type="radio" id="{{ name }}-yes" name="{{ name }}" value="1" {{ value ? 'checked="checked"' }}/>
    {{ ctx.wgLang.message( 'form-yes' ) }}
  </label>&nbsp;
  <label class="radio-inline">
    <input type="radio" id="{{ name }}-no" name="{{ name }}" value="0" {{ not(value) ? 'checked="checked"' }}/>
    {{ ctx.wgLang.message( 'form-no' ) }}
  </label>
</div>
{{ forms.endElement() }}
{% endmacro %}

{% macro dob( ctx, mesg, dayName, monthName, yearName, opts = {} ) %}
{% import _self as forms %}
{% set dayValue = ctx.form.get( dayName ) %}
{% set monthValue = ctx.form.get( monthName ) %}
{% set yearValue = ctx.form.get( yearName ) %}
{% if dayName in ctx.form.errors or monthName in ctx.form.errors or yearName
in ctx.form.errors %}
{% set class = 'dob has-error' %}
{% else %}
{% set class = 'dob' %}
{% endif %}
{% set opts = { 'class':class, 'required':false }|merge( opts ) %}
{% set required = opts['required'] ? 'required' : '' %}

{{ forms.startElement( ctx, mesg, '', opts ) }}
  <div class="form-inline">
  <select class="form-control" id="{{ dayName }}" name="{{ dayName }}" {{ required }}>
    <option value="">{{ ctx.wgLang.message( 'form-select-day' ) }}</option>
    {% for i in 1..31 %}
    <option value="{{ "%d"|format(i) }}" {{ i == dayValue ? 'selected="selected"' }}>{{ i }}</option>
    {% endfor %}
  </select>&nbsp;
  <select class="form-control" id="{{ monthName }}" name="{{ monthName }}" {{ required }}>
    <option value="">{{ ctx.wgLang.message( 'form-select-month' ) }}</option>
    {% for idx, month in ctx.wgLang.message( 'MONTH_NAMES' ) %}
    {% set i = idx + 1 %}
    <option value="{{ "%d"|format(i) }}" {{ i == monthValue ? 'selected="selected"' }}>{{ month }}</option>
    {% endfor %}
  </select>&nbsp;
  <select class="form-control" id="{{ yearName }}" name="{{ yearName }}" {{ required }}>
    <option value="">{{ ctx.wgLang.message( 'form-select-year' ) }}</option>
    {% set thisYear = 'now'|date('Y') %}
    {% for i in range(thisYear, thisYear - 130, -1) %}
    <option value="{{ i }}" {{ i == yearValue ? 'selected="selected"' }}>{{ i }}</option>
    {% endfor %}
  </select>
</div>
{{ forms.endElement() }}
{% endmacro %}

{% macro i18nSelect( ctx, mesg, name, options, opts = {} ) %}
{% import _self as forms %}
{% set opts = { 'required':false }|merge( opts ) %}
{% set value = ctx.form.get( name ) %}
{{ forms.startElement( ctx, mesg, name, opts ) }}
<select class="form-control" id="{{ name }}" name="{{ name }}" {{ opts['required'] ? 'required' }}>
  <option value="">{{ ctx.wgLang.message( 'form-select' ) }}</option>
  {% for label, val in options %}
  <option value="{{ val }}" {{ val == value ? 'selected="selected"' }}>{{ ctx.wgLang.message( label ) }}</option>
  {% endfor %}
</select>
{{ forms.endElement() }}
{% endmacro %}

{% macro wikiSelect( ctx, mesg, names, options, opts = {} ) %}
{% import _self as forms %}
{% set opts = { 'required':false }|merge( opts ) %}
{{ forms.startElement( ctx, mesg, names[0], opts ) }}
  {% for name in names %}
  {% set value = ctx.form.get( name ) %}
  <select id="{{ name }}" name="{{ name }}" class="form-control chosen-select" {{ opts['required'] ? 'required' }}>
    <option value="">{{ ctx.wgLang.message( 'form-select' ) }}</option>
    {% for val in options %}
    <option value="{{ val }}" {{ val == value ? 'selected="selected"' }}>{{ val }}</option>
    {% endfor %}
  </select>
  {% endfor %}
{{ forms.endElement() }}
{% endmacro %}

{% macro checkboxList( ctx, mesg, options, opts = {} ) %}
{% import _self as forms %}
{{ forms.startElement( ctx, mesg, '', opts ) }}
  {% for name, label in options %}
  {% set value = ctx.form.get( name ) %}
  <div class="checkbox">
  <label>
    <input type="checkbox" id="{{ name }}" name="{{ name }}" value="1" {{ value ? 'checked="checked"' }}/>&nbsp;
    {{ label }}
  </label>
</div>
  {% endfor %}
{{ forms.endElement() }}
{% endmacro %}

{% macro checkbox( ctx, mesg, name, opts = {} ) %}
{% import _self as forms %}
{% set opts = { 'required':false, 'escape':true }|merge( opts ) %}
{% set value = ctx.form.get( name ) %}
{% set tran = ctx.wgLang.message( mesg ) %}
{{ forms.div( ctx, mesg, name, opts ) }}
<div class="checkbox">
  <label class="{{ opts['required'] ? 'required' }}">
    <input type="checkbox" id="{{ name }}" name="{{ name }}" value="1" {{ value ? 'checked="checked"' }} {{ opts['required'] ? 'required' }}/>&nbsp;
    {% if opts['escape'] == false %}{{ tran|raw }}{% else %}{{ tran }}{% endif %}
  </label>
</div>
</div>
{% endmacro %}
